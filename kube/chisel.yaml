apiVersion: apps/v1
kind: Deployment
metadata:
  name: chisel
spec:
  replicas: 1
  selector:
    matchLabels:
      app: chisel
  template:
    metadata:
      labels:
        app: chisel
    spec:
      containers:
        - name: chisel
          image: jpillora/chisel
          # TODO: secure the server with --authfile
          # https://github.com/jpillora/chisel#authentication
          args: [ "server", "-v", "-p", "8080", "--reverse" ]
          ports:
            - containerPort: 8080
              name: http
            - containerPort: 8081
              name: forwarded-theo
            - containerPort: 8082
              name: forwarded-alex
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 3
            periodSeconds: 120
            successThreshold: 1
          resources:
            limits:
              cpu: 500m
              memory: 500Mi
            requests:
              cpu: 50m
              memory: 200Mi
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    cloud.google.com/app-protocols: '{"forwarded-theo":"HTTP2", "forwarded-alex":"HTTP2", "tunnel": "HTTP2"}'
    # duplicating because mimicking https://gist.github.com/viglesiasce/bcdacc95068803be565a45b215bf069f
    service.alpha.kubernetes.io/app-protocols: '{"forwarded-theo":"HTTP2", "forwarded-alex":"HTTP2", "tunnel": "HTTP2"}'
  name: chisel
spec:
  selector:
    app: chisel
  ports:
    - protocol: TCP
      targetPort: http
      port: 8080
      name: tunnel
    - protocol: TCP
      targetPort: forwarded-theo
      port: 8081
      name: forwarded-theo
    - protocol: TCP
      targetPort: forwarded-alex
      port: 8082
      name: forwarded-alex
  type: NodePort
